# 演示者和谦虚对象

在第22章中，我们介绍了演示者的概念。演示者是谦虚对象模式的一种形式，它帮助我们识别和保护架构边界。实际上，上一章的《清洁架构》中充满了谦虚对象的实现。

## 谦虚对象模式

谦虚对象模式是一种设计模式，最初被视为帮助单元测试人员将难以测试的行为与易于测试的行为分离的一种方法。这个想法非常简单：将行为拆分成两个模块或类。其中一个模块是谦虚的，它包含了所有难以测试的行为，这些行为被简化到了最基本的要素。另一个模块包含了从谦虚对象中剥离出来的所有可测试行为。

例如，GUI很难进行单元测试，因为很难编写测试来查看屏幕并检查其中显示的元素是否正确。但是，GUI的大多数行为实际上是很容易测试的。使用谦虚对象模式，我们可以将这两种行为分成两个不同的类，称为Presenter和View。

## 演示者和视图

视图是难以测试的谦虚对象。该对象中的代码尽可能简单。它将数据移动到GUI中，但不处理该数据。演示者是可测试的对象。它的工作是接受来自应用程序的数据并对其进行格式化，以便视图可以简单地将其移动到屏幕上。

例如，如果应用程序想要在字段中显示日期，则会将Date对象交给Presenter。然后，演示者将将该数据格式化为适当的字符串并将其放置在称为View Model的简单数据结构中，视图可以在其中找到它。

如果应用程序想要在屏幕上显示货币，则可能会将货币对象传递给演示者。演示者将使用适当的小数位数和货币标记格式化该对象，创建一个字符串，它可以将其放置在View Model中。如果该货币值为负，则应将其转为红色，这时在View model中设置一个简单的布尔标志即可。

屏幕上的每个按钮都有一个名称。该名称是View Model中的一个字符串，由演示者放置在其中。如果这些按钮应该变灰，则Presenter会在View model中设置适当的布尔标志。每个菜单项名称都是View model中的一个字符串，由Presenter加载。每个单选按钮、复选框和文本字段的名称都由Presenter加载到View model中的适当字符串和布尔值中。应该在屏幕上显示的数字表格由Presenter加载到View model中的格式正确的字符串表格中。

出现在屏幕上的任何事物，以及应用程序对其的某种控制，都表示为View Model中的一个字符串、布尔值或枚举。除了从View Model中加载数据到屏幕之外，View没有其他事情要做。因此，视图是谦虚的。

## 测试和架构

长期以来，测试性一直被认为是良好架构的一个特征。谦虚对象模式是一个很好的例子，因为将行为分成可测试和不可测试的部分往往定义了一条架构边界。Presenter/View边界就是其中之一，但还有许多其他的边界。

## 数据库网关

在用例交互器和数据库之间是数据库网关。这些网关是多态接口，包含应用程序可以在数据库上执行的每个创建、读取、更新或删除操作的方法。例如，如果应用程序需要知道昨天所有登录的用户的姓氏，则UserGateway接口将有一个名为getLastNamesOfUsersWhoLoggedInAfter的方法，该方法以Date作为其参数并返回姓氏列表。

回想一下，我们不允许在用例层中使用SQL，而是使用具有适当方法的网关接口。这些网关由数据库层中的类实现。该实现是谦虚对象。它只需使用SQL或数据库接口来访问每个方法所需的数据。相反，交互器不是谦虚的，因为它们封装了特定于应用程序的业务规则。虽然它们不是谦虚的，但这些交互器是可测试的，因为网关可以被适当的存根和测试替身所替代。

## 数据映射器

回到数据库的话题，您认为像 Hibernate 这样的 ORM 属于哪一层？

首先，让我们搞清楚一件事：不存在所谓的对象关系映射器（ORM）。原因很简单：对象不是数据结构。至少从用户的角度来看，它们不是数据结构。对象的用户无法看到数据，因为它们都是私有的。这些用户只能看到该对象的公共方法。因此，从用户的角度来看，对象仅仅是一组操作。

相反，数据结构是一组没有隐含行为的公共数据变量。ORM 更应该被称为“数据映射器”，因为它们将数据加载到数据结构中，以便从关系数据库表中获取数据。

这样的 ORM 系统应该放置在哪一层？当然是数据库层。实际上，ORM 形成了另一种谦卑对象边界，位于网关接口和数据库之间。

## 服务监听器

那么服务怎么样？如果您的应用程序必须与其他服务通信，或者如果您的应用程序提供一组服务，那么我们会发现谦卑对象模式会创建一个服务边界吗？

当然会！应用程序将数据加载到简单的数据结构中，然后将这些结构通过边界传递到适当格式化数据并将其发送到外部服务的模块中。在输入端，服务监听器将从服务接口接收数据，并将其格式化为可以被应用程序使用的简单数据结构。然后将该数据结构传递到服务边界。

## 结论

在每个架构边界处，我们很可能会发现谦虚对象模式潜伏在附近。跨越该边界的通信几乎总是涉及某种简单的数据结构，并且该边界通常将难以测试的东西与易于测试的东西分开。在架构边界处使用此模式极大地增加了整个系统的可测试性。